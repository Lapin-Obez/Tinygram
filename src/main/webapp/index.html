<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TinyGram</title>
<link rel="stylesheet" href="application.css">
<link rel="icon" href="favicon.png">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-signin-scope" content="profile email">
<meta name="google-signin-client_id" content="622187817241-fqke0l023q148lc21gv1qthq82imi4mg.apps.googleusercontent.com">

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script>
<!--
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
-->
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

<script src="https://unpkg.com/mithril/mithril.js"></script>

</head>
<body>
    <script>
        var me;
        function handleCredentialResponse(response) {
            console.log("callback called:"+response.credential)
            // decodeJwtResponse() is a custom function defined by you
            // to decode the credential response.
            const responsePayload = jwt_decode(response.credential);
            console.log("ID: " + responsePayload.sub);
            console.log('Full Name: ' + responsePayload.name);
            console.log('Given Name: ' + responsePayload.given_name);
            console.log('Family Name: ' + responsePayload.family_name);
            console.log("Image URL: " + responsePayload.picture);
            console.log("Email: " + responsePayload.email);
                        
            /*const url = "_ah/api/myApi/v1/Hello"+'?access_token=' + response.credential
            fetch(url).then(response => response.text()).then(data => )*/
            if(responsePayload != null){
                m.request({
	                method: "GET",
	                url: "_ah/api/myApi/v1/addUser?access_token="+response.credential
	            }).then(function(result){
	        	    console.log("got:",result.properties.name);
                    me = response.credential;
                    m.mount(document.body,PostForm)
	            }).catch(function (e) {
                    console.log(e);
                })
                m.redraw();
            }
        }

        var LogPage = {
            view: function() {
                return m("a", [
                    m('div',{
                        id: 'g_id_onload',
                        'data-client_id': '622187817241-fqke0l023q148lc21gv1qthq82imi4mg.apps.googleusercontent.com',
                        'data-callback':"handleCredentialResponse" ,
                    }),
                    m('div',{class:'g_id_signin', 'data-type':'standard'})
                ])
            }
        }

 
        var PostForm = {
            url:"",
            body:"",
            myListIFollowThem:[me,me,me,me,me,me,me,me,me,me,me], //l'enlever apr√®s tests
            /*
            oninit: function(){
                myListIFollowThem[0] = me;
            },
            */
            view: function(){
                //console.log("myListIFollowThem : " + jwt_decode(myListIFollowThem[0]).name);
                return m("main",[
                    m('div', [
                        m('div',{class:'listMyPost'},"My Posts"),
                        m('table', {class:'table is-striped'},[
                            m('tr', [
                            m('th', {width:"300px"}, "url"),
                            m('th', {width:"100px"}, "body"),
                            m('th',{class:"button"},"like")
                            ])
                        ])
                    ]),
                    m("img",{class:'imageUser',"src":jwt_decode(me).picture}),
                    m('div', {class:'blockListIFollowThem'}, [
                        m('div',{class:'titleListIFollowThem'},"Followed Accounts"),
                        m('table', {class:'tableFollowedAccounts'},[
                            m('tr', [
                                m('th',{class:'columnImageUserFollowed'}, ""),
                                m('th',{class:'columnNameUserFollowed'}, "")
                            ]),
                            PostForm.myListIFollowThem.map(function(item) {
                                return m("tr", [
                                    m('td', {class:'cellImageUserFollowed'}, m('img', {class:'imageUserFollowed','src':"favicon.png"})),
                                    m('td', m('div', {class:"nameAccount"}, "ouais ouais ouais"))//jwt_decode(item).name
                                ])
                            })
                        ])
                    ]),
                    m("form", {
                        onsubmit: function(e) {
                            e.preventDefault()
                            if (url="") {url="https://dummyimage.com/320x200/000/fff&text="+Date.now()} 
                            if (body="") {body="bla bla bla \n"+Date.now()}
                            MyPost.postMessage()
                        }
                    }, 
                    [
                        m('div', {class:'field'},[
                        m("label", {class:'label'},"URL"),
                        m('div',{class:'control'}, m("input[type=text]", {
                        class:'input is-rounded',
                        placeholder:"Your url",
                            oninput: function(e) {PostForm.url = e.target.value}})),
        //		         m("img",{"src":this.url}),
                        ]),
                        m('div',{class:'field'},[
                            m("label", {class: 'label'},"Body"),
                            m('div',{class:'control'},m("input[type=textarea]", {
                            class:'textarea',
                            placeholder:"your text",
                            oninput: function(e) { PostForm.body = e.target.value }})),
                        ]),
                        m('div',{class:'control'},m("button[type=submit]", {class:'button is-link'},"Post")),
                    ])
                ])
            }
        }
 
 
        var MyPost = {
                list: [],
                nextToken: "",
                loadList: function() {
                    return m.request({
                        method: "GET",
                        url: "_ah/api/myApi/v1/getPost?access_token="+me})
                    .then(function(result) {
                        console.log("got:",result)
                        MyPost.list=result.items
                        if ('nextPageToken' in result) {
                            MyPost.nextToken= result.nextPageToken
                        } else {
                            MyPost.nextToken=""
                        }})
                },
                next: function() {
                    return m.request({
                        method: "GET",
                        url: "_ah/api/myApi/v1/mypost/"+me+"?next="+MyPost.nextToken})
                    .then(function(result) {
                        console.log("got:",result)
                        result.items.map(function(item){MyPost.list.push(item)})
                        if ('nextPageToken' in result) {
                            MyPost.nextToken= result.nextPageToken
                        } else {
                            MyPost.nextToken=""
                        }})
                },
                postMessage: function() {
                    /* var data={
                            'url':PostForm.url,
                            'body':PostForm.body}
                    console.log("post:"+data)*/
                    return m.request({
                        method: "GET",//"_ah/api/myApi/v1/postMessage?access_token="+me
                        url: "_ah/api/myApi/v1/likeMessage/gabrielpouplin@gmail.com:9223370369274456451/?access_token="+me,
                        //params : data,            
                    })
                    .then(function(result) {
                            console.log("got:",result)
                            

                        }).catch(function (e) {
                            console.log(e);
                        })
                }
        }
        
        var PostView = {
        oninit: MyPost.loadList,
        view: function() {
                return m('div', [
            m('div',{class:'listMyPost'},"My Posts"),
            m('table', {class:'table is-striped',"table":"is-striped"},[
                m('tr', [
                m('th', {width:"50px"}, "like"),
                m('th', {width:"50px"}, "del"),
                m('th', {width:"50px"}, "Bodys"),
                m('th', {width:"50px"}, "Urls"),
                m('th', {width:"50px"}, "Like"),
                ]),
                MyPost.list.map(function(item) {
                return m("tr", [
                    m("td", m("button", {onclick: function(e) {
                        console.log("like:"+item.key.id)
                        }},"like")),
                        m("td", m("button", {onclick: function(e) {
                            console.log("del:"+item.key.id)
                        }},"del")),
                    m('td', m('label', item.properties.body)),
                    m('td', m('img', {class: 'is-rounded', 'src': item.properties.url})),
                    m('td', m('label', item.properties.likec)),
                ])
                }),
        //	    m("div", isError ? "An error occurred" : "Saved"),
                m('button',{
                    class: 'button is-link',
                    onclick: function(e) {MyPost.next()}
                    },
                "Next"),
                ])
            ])
        }
        }

        m.mount(document.body,LogPage)        
    </script>
</body>
</html>